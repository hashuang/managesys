{% extends "data_import/base.html" %}
{% block title %}{% if title %}{{ title }}{% endif %}{% endblock %}
{% block pagejs %}
<script type="text/javascript" src="/static/data_import/libs/echarts/echarts.js"></script>
{% endblock pagejs %}
{% block content %}

<h2>青钢转炉数据分析-转炉-成本-单炉次</h2>
<h7><a href='/fluctuation'>To波动率分析页面  </a><a href='/test'>  To时间插件测试</a></h7>
<div style="width:1000px">
    <div style="width:850px">

        <!-- 隐藏域 -->
        <input type="hidden" name="hidden_inform1" id='hidden_inform1'>
        <input type="hidden" name="hidden_inform2" id='hidden_inform2'>
        <input type="hidden" name="hidden_inform3" id='hidden_inform3'>
        <input type="hidden" name="hidden_inform4" id='hidden_inform4'>
        <input type="hidden" name="hidden_inform5" id='hidden_inform5'>
        <input type="hidden" name="hidden_inform6" id='hidden_inform6'>

        <!-- <p><strong>单炉次成本相关字段分析</strong></p> -->
        <p>请输入炉次号，例如：1634230，并选择筛选条件。注：当前数据库数据截至2016年7月！</p>
        <label>炉次号：</label><input type="text" name="prime_analyse" value="1634230" id="prime_analyse">
        <label>钢种：</label><select name="SPECIFICATION" id="SPECIFICATION" class="SPECIFICATION_name">
                <option value='all' selected = "selected">所有钢种</option>
                <option value='native'>本钢种</option>

            </select>
        <label>班别：</label><select name="OPERATECREW" id="OPERATECREW" class="OPERATECREW_name">
                <option value='all' selected = "selected">所有班别</option>
                <option value='native'>本班别</option>
                <option value='A'>甲班</option>
                <option value='B'>乙班</option>
                <option value='C'>丙班</option>
            </select>
        <label>对比时间：</label>
                <div id="reportrange" class="pull-right dateRange" style="width:250px;height:26px">
                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                    <span id="searchDateRange"></span>
                    <b class="caret"></b>
                </div>

    </div>
    <button onclick="cost_produce()" id='click2' style="width:150px;height:26px;margin-top:5px">成本字段分析</button>
</div>

<div style="width:1550px">
    <div id="main1" style="float:left;width:700px;height:300px"></div>
    <div id="main2" style="float:left;width:800px;height:300px"></div>
    <div id="main3" style="float:left;width:700px;height:300px"></div>
    <div id="main4" style="float:left;width:800px;height:300px"></div>
    <div id='cause_area' style="float:left;width:700px;height:250px;margin-top:5px">
        <p><strong>转炉工序单炉次字段成本追溯结果：</strong></p>
        <textarea id="cause_txt" style="width: 700px;height:250px;"></textarea>
    </div>
    <div style="float:right;width:800px;height:450px">
        <div id="main5" style="float:left;width:700px;height:350px"></div>
        <div id='coloum_div' style="width:700px;height:100px">
            <!-- 改变柱状个数 -->
            <lebel >请选择分布区间数：</lebel>
            <select name='change_column' id='change_column' onChange="change_column()">
                <option value='5'>5 </option>
                <option value='7'>7 </option>
                <option value='9' selected="selected">9 </option>
                <option value='21'>21 </option>
          </select>
        </div>
    </div>
</div>


<!-- <button onclick='updatevalue()' id='updatevalue'>定期更新数据库转炉字段统计值</button> -->
<!-- <link href="/static/data_import/bootstrap.min.css" rel="stylesheet"> -->
<link rel="stylesheet" type="text/css" media="all" href="/static/data_import/daterangepicker+bootstrap2.3.1/daterangepicker-bs3.css" />
<link rel="stylesheet" type="text/css" media="all" href="/static/data_import/daterangepicker+bootstrap2.3.1/daterangepicker-1.3.7.css" />
<link href="/static/data_import/daterangepicker+bootstrap2.3.1/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="/static/data_import/daterangepicker+bootstrap2.3.1/moment.js"></script>
<script type="text/javascript" src="/static/data_import/daterangepicker+bootstrap2.3.1/daterangepicker-1.3.7.js"></script>

<script type="text/javascript" src="/static/data_import/js/loadChart_chen.js"></script>
<script type="text/javascript">
    // //定期更新数据库中表结构表中的期望等参数值(现已单独成文件，不放在整体程序中)
    // function updatevalue(){
    //     $.ajax({
    //     type: "post",
    //     url:  "/updatevalue",
    //     data: {},
    //     error: function() {
    //         alert("发生错误！");
    //     },
    //     success: function(data) {
    //         alert(data.state);
    //     }
    //  })
    // }



    //改变概率直方分布的柱状个数
    function change_column(){
        var fieldname_english = $("#hidden_inform1").val();
        var fieldname_chinese = $("#hidden_inform2").val();
        var actual_value = $("#hidden_inform3").val();
        var offset_value = $("#hidden_inform4").val();
        probability_normal(fieldname_chinese,fieldname_english,offset_value,actual_value);

    }
    //成本消耗
    function cost_produce(){
        var heat_no = $("#prime_analyse").val();
        var SPECIFICATION = $("#SPECIFICATION").val();
        var OPERATECREW = $("#OPERATECREW").val();
        var starttime = $('#hidden_inform5').val();
        var endtime = $('#hidden_inform6').val();
        console.log(heat_no)
        $.ajax({
            type: "post",
            url:  "/cost_produce",
            data: {'heat_no':heat_no,'SPECIFICATION':SPECIFICATION,'OPERATECREW':OPERATECREW,'starttime':starttime,'endtime':endtime},
            error: function() {
                alert("错误！！");
            },
            success: function(data) {
                //alert(data.result);
                //alert(data.result.xname)
                //alert(data.result.yvalue)
                // alert(data.result.offset_result[0]);
                // $("#offset").val(data.result.offset_result[0]);
                    if (data.state=='error'){
                        // alert('当前筛选条件无可分析数据！')
                        $("#main1").empty();
                        $("#main1").append("\n\n\n\n注：当前"+heat_no+"炉次不存在！");
                        $("#main2").empty();
                        $("#main3").empty();
                        $("#main4").empty();
                        // $("#cause_area").hide();
                        $("#main5").empty();
                        $("#coloum_div").hide();

                    }else{
                    drawBarChart_raw(data.result);
                    drawBarChart_material(data.result);
                    drawBarChart_product(data.result);
                    drawBarChart_alloy(data.result);
                    $("#coloum_div").hide();
                    $("#main5").empty();
                    regression_analyse(data.result);
                    // alert(data.result.raw.heat_no);
                    // alert(data.result.raw.str_select);
                    }

            }
        })
    };
    function regression_analyse(result){
         var heat_no = $("#prime_analyse").val();
         var str_select = result.raw.str_select;
         var json_result = JSON.stringify(result);
         // alert(json_result);
         // alert(result);
          $.ajax({
            type: "post",
            url:  "/regression_analyse",
            data: {'heat_no':heat_no,'str_select':str_select,'result':json_result},
            error: function() {
                alert("错误！！");
            },
            success: function(data) {
                // alert(data.str_cause);
                $("#cause_txt").empty();
                $("#cause_txt").append(data.str_cause);
                $("#cause_area").show();
            }
        })


    }

    //回归系数因素追溯及其偏离程度
    function retrospectfactor(fieldname_english,fieldname_chinese,offset_value){
        var heat_no = $("#prime_analyse").val();
        // console.log(prime_analyse)
        $.ajax({
            type: "post",
            url:  "/max_influence",
            data: {'field':fieldname_english,'offset_value':offset_value,'heat_no':heat_no},
            error: function() {
                alert("错误！！");
            },
            success: function(data) {
                //alert(data.result)
                // alert("success");
                // alert(data.offset_number);//字段个数
                // alert(data.xasis_fieldname);//字段英文名数组
                // alert(data.offset_result);//字段偏离程度
                // alert(data.En_to_Ch_result);//字段中文名
                // alert(data.regression_coefficient);
                // $("#txt").empty();//清除表格内容
                $("#cause_txt").empty();//清除文本框内容
                // $("#cause_txt").append('单炉次'+field+'字段因素追溯的分析结果:\n');
                $("#cause_txt").append('经分析，'+heat_no+'炉次下的'+fieldname_chinese+'('+fieldname_english+')字段，偏离程度为'+offset_value+'。通过数据相关性分析发现，导致该问题的原因是:\n');
                // var content='';
                // $("#txt").append("<caption >"+field+"字段因素追溯的分析结果</caption><tr> <th>序号</th><th>影响因素中文名</th><th>影响因素英文名</th><th>影响因素回归系数</th><th>影响因素偏离值</th></tr>");
                for (var i=0;i<data.offset_number;i++){
                    // content=content+(i+1)+" : "+data.En_to_Ch_result[i]+"; "+data.xasis_fieldname[i]+"; "+data.regression_coefficient[i]+"; "+data.offset_result[i]+"\n";
                    // $("#txt").append(" <tr> <th>"+(i+1)+"</th><th>"+data.En_to_Ch_result[i]+"</th><th>"+data.xasis_fieldname[i]+"</th><th>"+data.regression_coefficient[i]+"</th><th>"+data.offset_result[i]+"</th></tr>")

                    if (i < 5){
                        $("#cause_txt").append('     No.'+(i+1)+' 相关字段为: '+data.En_to_Ch_result[i]+'('+data.xasis_fieldname[i]+")，其偏离程度为："+data.offset_result[i]+'，权重系数为：'+data.regression_coefficient[i]+"。\n");
                    }

                }
                $("#cause_area").show();//此时将隐藏的显示追溯结果的文本区域显示出来
                // alert(content);


            }
        })
    };

    // 条形图（原料raw）(多Y轴)
    function drawBarChart_raw(result){
        var myChart = echarts.init(document.getElementById('main1'));
        var colors = ['#FF8C69','#FF8247','#FF7256','#FF6347','#FF34B3','#FF0000','#FF7F50','#FF7F24'];
        var barWidth_value=40;//柱条（K线蜡烛）宽度
        var barGap_value='100%';//柱间距离，默认为柱形宽度的30%，可设固定值
        var barCategoryGap_value='60%';//类目间柱形距离，默认为类目间距的20%，可设固定值

            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '炉次号'+result.raw.heat_no+'的原料组成',
                    x:'center'
                },
                tooltip: {
                    // trigger: 'axis',
                    // axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    //     type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        trigger:'item',
                        formatter: function (params){
                            var res = result.raw.xname[params.seriesIndex]+':</br>实际值：'+params.value+result.raw.danwei[params.seriesIndex] + '<br/>偏离程度：'+result.raw.offset_result[params.seriesIndex]+'</br>定性判断：'+result.raw.qualitative_offset_result[params.seriesIndex];
                            return res;

                     }
                },
                toolbox: {
                    show : true,
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: ['单炉次原料投入字段']
                },
                yAxis: [{
                    type: 'value',
                    name: '铁水重量(Kg)',
                    min: 0,
                    max: 105000,
                    position: 'left',
                    offset:-20,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '生铁(Kg)',
                    min: 0,
                    max: 12000,
                    position: 'left',
                    offset: -100,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[1]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} NM3'
                    // }
                },
                {
                    type: 'value',
                    name: '废钢总和(Kg)',
                    min: 0,
                    max: 12000,
                    position: 'left',
                    splitLine:{show: false},//去除网格线
                    offset: -180,
                    axisLine: {
                        lineStyle: {
                            color: colors[2]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '大渣钢(Kg)',
                    min: 0,
                    max: 10000,
                    position: 'left',
                    offset: -260,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[3]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '自产废钢(Kg)',
                    min: 0,
                    max: 10000,
                    position: 'left',
                    offset: -340,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[4]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '重型废钢(Kg)',
                    min: 0,
                    max: 10000,
                    position: 'left',
                    offset: -420,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[5]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '中型废钢(Kg)',
                    min: 0,
                    max: 10000,
                    position: 'left',
                    offset: -500,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[6]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                }
                ],
                series: [{
                    name: '铁水重量',
                    type: 'bar',
                    barWidth : barWidth_value,//柱条（K线蜡烛）宽度
                    barGap: barGap_value,//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap: barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    data: [result.raw.yvalue[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'生铁',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.raw.yvalue[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'废钢总和',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.raw.yvalue[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'大渣钢',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 3,
                    data:[result.raw.yvalue[3]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'自产废钢',
                    type:'bar',
                   barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 4,
                    data:[result.raw.yvalue[4]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'重型废钢',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 5,
                    data:[result.raw.yvalue[5]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'中型废钢',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 6,
                    data:[result.raw.yvalue[6]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                }
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                fieldname_chinese=result.raw.xname[params.seriesIndex];
                fieldname_english=result.raw.xEnglishname[params.seriesIndex];
                str_select=result.raw.str_select;
                probability_normal(fieldname_chinese,fieldname_english,result.raw.offset_result[params.seriesIndex],params.value,str_select);
                $("#hidden_inform1").val(fieldname_english);//字段英文名
                $("#hidden_inform2").val(fieldname_chinese);//字段中文名
                $("#hidden_inform3").val(params.value);//实际值
                $("#hidden_inform4").val(result.raw.offset_result[params.seriesIndex]);//偏离程度
            }
            console.log(params);
            });

            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。
    };

    // 条形图（物料material）(多Y轴)
    function drawBarChart_material(result){
        var myChart = echarts.init(document.getElementById('main2'));
        var colors = ['#5793f3', '#d14a61', '#675bba','#00c957','#5793f3', '#d14a61', '#675bba','#00c957'];
        var barWidth_value=40;
        var barGap_value='100%';
        var barCategoryGap_value='60%';

            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '炉次号'+result.material.heat_no+'的物料组成',
                    x:'center'
                },
                tooltip: {
                    // trigger: 'axis',
                    // axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    //     type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        trigger:'item',
                        formatter: function (params){
                            var res = result.material.xname[params.seriesIndex]+':</br>实际值：'+params.value+result.material.danwei[params.seriesIndex] + '<br/>偏离程度：'+result.material.offset_result[params.seriesIndex]+'</br>定性判断：'+result.material.qualitative_offset_result[params.seriesIndex];
                            return res;

                     }
                },
                toolbox: {
                    show : true,
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: ['单炉次物料投入字段']
                },
                yAxis: [{
                    type: 'value',
                    name: '总吹氧消耗(NM3)',
                    // min: 0,
                    // max: 105000,
                    position: 'left',
                    offset:20,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '氮气耗量(NM3)',
                    // min: 0,
                    // max: 12000,
                    position: 'left',
                    offset: -60,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[1]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} NM3'
                    // }
                },
                {
                    type: 'value',
                    name: '1#烧结矿(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    splitLine:{show: false},//去除网格线
                    offset: -140,
                    axisLine: {
                        lineStyle: {
                            color: colors[2]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '石灰石(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -220,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[3]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '萤石(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -300,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[4]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '增碳剂(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -380,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[5]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '低氮增碳剂(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -460,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[6]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '石灰(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -540,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[7]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '轻烧白云石(Kg)',
                    min: 0,
                    max: 8000,
                    position: 'left',
                    offset: -620,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[8]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                }
                ],
                series: [{
                    name: '总吹氧消耗',
                    type: 'bar',
                    barWidth : barWidth_value,//柱条（K线蜡烛）宽度
                    barGap: barGap_value,//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap: barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    data: [result.material.yvalue[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'氮气耗量',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.material.yvalue[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'1#烧结矿',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.material.yvalue[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'石灰石',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 3,
                    data:[result.material.yvalue[3]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'萤石',
                    type:'bar',
                   barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 4,
                    data:[result.material.yvalue[4]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'增碳剂',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 5,
                    data:[result.material.yvalue[5]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'低氮增碳剂',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 6,
                    data:[result.material.yvalue[6]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'石灰',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 7,
                    data:[result.material.yvalue[7]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'轻烧白云石',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 8,
                    data:[result.material.yvalue[8]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                }
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                fieldname_chinese=result.material.xname[params.seriesIndex];
                fieldname_english=result.material.xEnglishname[params.seriesIndex];
                str_select=result.material.str_select;
                probability_normal(fieldname_chinese,fieldname_english,result.material.offset_result[params.seriesIndex],params.value,str_select);
                $("#hidden_inform1").val(fieldname_english);//字段英文名
                $("#hidden_inform2").val(fieldname_chinese);//字段中文名
                $("#hidden_inform3").val(params.value);//实际值
                $("#hidden_inform4").val(result.material.offset_result[params.seriesIndex]);//偏离程度
            }
            console.log(params);
            });

            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。
    };

    // 条形图（产品product）（多Y轴）
    function drawBarChart_product(result){
        var myChart = echarts.init(document.getElementById('main3'));
        var colors = ['#5793f3', '#d14a61', '#675bba','#00c957','#5793f3', '#d14a61', '#675bba','#00c957'];
        var barWidth_value=60;
        var barGap_value='100%';
        var barCategoryGap_value='60%';
            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '炉次号'+result.raw.heat_no+'的产品组成',
                    x:'center'
                },
                tooltip: {
                    // trigger: 'axis',
                    // axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    //     type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        trigger:'item',
                        formatter: function (params){
                            var res = result.product.xname[params.seriesIndex]+':</br>实际值：'+params.value+result.product.danwei[params.seriesIndex] + '<br/>偏离程度：'+result.product.offset_result[params.seriesIndex]+'</br>定性判断：'+result.product.qualitative_offset_result[params.seriesIndex];
                            return res;

                     }
                },
                toolbox: {
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: ['单炉次产品产出字段']
                },
                yAxis: [{
                    type: 'value',
                    name: '钢水(Kg)',
                    min: 0,
                    max: 105000,
                    position: 'left',
                    offset:-130,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '转炉煤气(NM3)',
                    min: 0,
                    max: 12000,
                    position: 'left',
                    offset: -250,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[1]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} NM3'
                    // }
                },
                {
                    type: 'value',
                    name: '钢渣(Kg)',
                    min: 0,
                    max: 22000,
                    position: 'left',
                    splitLine:{show: false},//去除网格线
                    offset: -370,
                    axisLine: {
                        lineStyle: {
                            color: colors[2]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                }
                ],
                series: [{
                    name: '钢水重量',
                    type: 'bar',
                    barWidth : barWidth_value,//柱条（K线蜡烛）宽度
                    barGap: barGap_value,//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap:barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    data: [result.product.yvalue[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'转炉煤气',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.product.yvalue[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'钢渣',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.product.yvalue[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                }
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                fieldname_chinese=result.product.xname[params.seriesIndex];
                fieldname_english=result.product.xEnglishname[params.seriesIndex];
                str_select=result.product.str_select;
                probability_normal(fieldname_chinese,fieldname_english,result.product.offset_result[params.seriesIndex],params.value,str_select);
                $("#hidden_inform1").val(fieldname_english);//字段英文名
                $("#hidden_inform2").val(fieldname_chinese);//字段中文名
                $("#hidden_inform3").val(params.value);//实际值
                $("#hidden_inform4").val(result.product.offset_result[params.seriesIndex]);//偏离程度
            }
            console.log(params);
            });

            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。
    };

    // 条形图（合金alloy）(多Y轴)
    function drawBarChart_alloy(result){
        var myChart = echarts.init(document.getElementById('main4'));
        var colors = ['#5793f3', '#d14a61', '#675bba','#00c957','#5793f3', '#d14a61', '#675bba','#00c957'];
        var barWidth_value=40;
        var barGap_value='100%';
        var barCategoryGap_value='60%';

            // 指定图表的配置项和数据
            var option = {
                color:colors,
                title: {
                    text: '炉次号'+result.alloy.heat_no+'的合金组成',
                    x:'center'
                },
                tooltip: {
                    // trigger: 'axis',
                    // axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                    //     type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        trigger:'item',
                        formatter: function (params){
                            var res = result.alloy.xname[params.seriesIndex]+':</br>实际值：'+params.value+result.alloy.danwei[params.seriesIndex] + '<br/>偏离程度：'+result.alloy.offset_result[params.seriesIndex]+'</br>定性判断：'+result.alloy.qualitative_offset_result[params.seriesIndex];
                            return res;

                     }
                },
                toolbox: {
                    show : true,
                    feature: {
                        dataView: {show: true, readOnly: false},
                        restore: {show: true},
                        saveAsImage: {show: true}
                        }
                },
                legend: {
                    data:['']
                },
                xAxis: {
                    type: 'category',
                    axisTick: {
                    alignWithLabel: true
                    },
                    data: ['单炉次合金投入字段']
                },
                yAxis: [{
                    type: 'value',
                    name: '硅铁(Kg)',
                    min: 0,
                    max: 5000,
                    position: 'left',
                    offset:-140,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[0]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '微铝硅铁(Kg)',
                    min: 0,
                    max: 5000,
                    position: 'left',
                    offset: -220,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[1]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} NM3'
                    // }
                },
                {
                    type: 'value',
                    name: '硅锰合金(Kg)',
                    min: 0,
                    max: 5000,
                    position: 'left',
                    splitLine:{show: false},//去除网格线
                    offset: -300,
                    axisLine: {
                        lineStyle: {
                            color: colors[2]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '高硅硅锰(Kg)',
                    min: 0,
                    max: 5000,
                    position: 'left',
                    offset: -380,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[3]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                },
                {
                    type: 'value',
                    name: '中碳铬铁(Kg)',
                    min: 0,
                    max: 5000,
                    position: 'left',
                    offset: -460,
                    splitLine:{show: false},//去除网格线
                    axisLine: {
                        lineStyle: {
                            color: colors[4]
                        }
                    },
                    // axisLabel: {
                    //     formatter: '{value} Kg'
                    // }
                }
                ],
                series: [{
                    name: '硅铁',
                    type: 'bar',
                    barWidth : barWidth_value,//柱条（K线蜡烛）宽度
                    barGap: barGap_value,//柱间距离，默认为柱形宽度的30%，可设固定值
                    barCategoryGap: barCategoryGap_value,//类目间柱形距离，默认为类目间距的20%，可设固定值
                    barMinHeight:10,//柱条最小高度，可用于防止某item的值过小而影响交互
                    data: [result.alloy.yvalue[0]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'微铝硅铁',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 1,
                    data:[result.alloy.yvalue[1]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'硅锰合金',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 2,
                    data:[result.alloy.yvalue[2]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'高硅硅锰',
                    type:'bar',
                    barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 3,
                    data:[result.alloy.yvalue[3]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                },
                {
                    name:'中碳铬铁',
                    type:'bar',
                   barWidth : barWidth_value,
                    barGap: barGap_value,
                    barCategoryGap: barCategoryGap_value,
                    barMinHeight:10,
                    yAxisIndex: 4,
                    data:[result.alloy.yvalue[4]],
                    itemStyle: {
                        normal: {
                            label : {
                                show: true, position: 'top'
                            }
                        }
                    }
                }
                ]
            };

            var ecConfig = echarts.config;
            myChart.on('click', function (params) {
            if (typeof params.seriesIndex != 'undefined') {
                //mes += '  seriesIndex : ' + param.seriesIndex;
                //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
                fieldname_chinese=result.alloy.xname[params.seriesIndex];
                fieldname_english=result.alloy.xEnglishname[params.seriesIndex];
                str_select=result.alloy.str_select;
                probability_normal(fieldname_chinese,fieldname_english,result.alloy.offset_result[params.seriesIndex],params.value,str_select);
                $("#hidden_inform1").val(fieldname_english);//字段英文名
                $("#hidden_inform2").val(fieldname_chinese);//字段中文名
                $("#hidden_inform3").val(params.value);//实际值
                $("#hidden_inform4").val(result.alloy.offset_result[params.seriesIndex]);//偏离程度
            }
            console.log(params);
            });

            myChart.setOption(option);
            // 使用刚指定的配置项和数据显示图表。
    };

    //正态分布+概率分布
    function probability_normal(fieldname_chinese,fieldname_english,offset_value,actual_value,str_select){
        var heat_no = $("#prime_analyse").val();//炉次号
        //var field2 = $("#field2").val();//字段
        //var field2 = $("#bookno1").find("option:selected").val();
        var fieldname_english=fieldname_english;//字段英文名
        var fieldname_chinese=fieldname_chinese;//字段中文名
        var coloum_number = $("#change_column").val();//定义概率正方分布的柱状图个数
        console.log(heat_no,fieldname_english,fieldname_chinese);
            $.ajax({
            type: "post",
            url:  "/probability_normal",
            data: {'heat_no':heat_no,'fieldname_english':fieldname_english,'fieldname_chinese':fieldname_chinese,'offset_value':offset_value,'actual_value':actual_value,'coloum_number':coloum_number,'str_select':str_select},
            error: function() {
                alert("404");
            },
            success: function(data) {
                // alert("enter probability_normal");
                //概率分布
                // alert(data.ana_result['scope']);
                // alert(data.ana_result['num']);
                //正态分布
                // alert(data.normal_result['normx']);
                // alert(data.normal_result['normy']);
                // alert(data.state);
                if(data.state=='error'){
                    // alert('数据量过少，无法形成统计分布图！');
                    $("#coloum_div").hide();
                    $('#main5').empty();
                    $('#main5').append('数据量过少，无法形成统计分布图！');

                }else{
                    probability_normal_picture(data);
                    $("#coloum_div").show();
                }
            }
        })

    };

    //正态分布+概率分布画图
    function probability_normal_picture(result){
        var myChart = echarts.init(document.getElementById('main5'));
        //var bookname=document.getElementById('bookno1')
            // 指定图表的配置项和数据
            var option = {
                title: {
                    text: result.base_result.fieldname_chinese+'('+result.base_result.fieldname+')的概率(bar)及正态(line)分布',
                    x:'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                        type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                     }
                },
                legend: {
                    data:['']
                },
                toolbox: {
                    show : true,
                    feature : {
                        dataView : {show: true, readOnly: false},
                        magicType : {show: true, type: ['line', 'bar']},
                        restore : {show: true},
                        saveAsImage : {show: true}
                    }
                },
                xAxis: [
                    {
                        data: result.ana_result.normx,
                        axisLabel :{
                                //interval:0,//横轴信息全部显示
                                //rotate: 60//60度角倾斜显示
                            }
                    },
                    {
                        type : 'category',
                        axisLine: {show:true},
                        axisTick: {show:true},
                        axisLabel: {show:true},
                        splitArea: {show:true},
                        splitLine: {show:true},
                        data : result.ana_result.scope,
                        show:false,
                    }
                ],
                yAxis: [{
                    name:'正态分布密度(line)'
                },
                {
                    name:'概率分布密度(bar)'
                }
                ],
                series: [{
                    name: '正态分布',
                    type: 'line',
                    xAxisIndex:0,
                    yAxisIndex:0,
                    data: result.ana_result.normy,
                    // markPoint: {
                    //     itemStyle : {
                    //          normal: {
                    //              color:'#1e90ff'
                    //          }
                    //      },
                    //     data:[
                    //             // {type : 'max', name: '最大值'},
                    //             // {type : 'min', name: '最小值'},
                    //             {name : '位置点偏离程度'+result.normal_result.offset_value, value : result.normal_result.actual_value, xAxis: result.normal_result.match_value, yAxis: result.normal_result.normy[result.normal_result.match_index]},
                    //     ]
                    // },
                    markLine: {
                        name:'炉次号'+result.base_result.fieldname+'的标线',
                        itemStyle : {
                            normal: {
                                color:'#1e90ff'
                            }
                        },
                        data:[
                                [
                                {name: '位置点偏离程度'+result.base_result.offset_value, value:  result.base_result.actual_value, xAxis: result.base_result.match_value, yAxis: 0},
                                {name: '标线1终点', xAxis: result.base_result.match_value, yAxis: 'max'}
                                ],
                                [{
                                    // 固定起点的 x 位置，用于模拟一条指向最大值的水平线
                                    name: '位置点偏离程度'+result.base_result.offset_value,
                                    value: result.base_result.offset_value,
                                    yAxis: 'max',
                                    xAxis: result.base_result.match_value
                                 },
                                 {
                                    type: 'max'
                                }],
                               ]

                    },
                    // itemStyle: {
                    //         normal: {
                    //         color: 'tomato',
                    //         // label : {
                    //         //     show: false, position: 'top'
                    //         // }
                    //     }
                    // }

                },
                  {
                    name: '概率分布',
                    type: 'bar',
                    xAxisIndex:1,//xAxis坐标轴数组的索引，指定该系列数据所用的横坐标轴
                    yAxisIndex:1,
                    data: result.ana_result.num,
                    // itemStyle: {
                    //     normal: {
                    //     color: '#675bba',
                    //     }
                    // }
                }
                ]

            };

        var ecConfig = echarts.config;
        // myChart.on('click', function (params) {
        //     // if (params.componentType == 'markPoint') {
        //         //mes += '  seriesIndex : ' + param.seriesIndex;
        //         //mes += '  dataIndex : ' + param.dataIndex+result.xEnglishname[param.dataIndex];
        //         offset_value=result.base_result.offset_value;//读取偏离值
        //         fieldname_english=result.base_result.fieldname;//读取字段英文名字
        //         retrospectfactor(fieldname_english,fieldname_chinese,offset_value);
        //     // }
        //     console.log(params);
        //     });

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);

    }

    //自动加载钢种
    function loadGrape_chen(){
        $.ajax({
        type: "POST",
        dataType:"json",
        url: "/getGrape" ,
        data: {'greet':'hello'},
        success: function(data){
            //alert(data.result);
            //alert(data.result.length);
            pnames=data.result;
            $(".gangzhong_name").append("<option value='blank' selected =\"selected\"></option>");
            for(var pname in pnames){
                console.log(pnames[pname])
                $(".gangzhong_name").append("<option value='"+pnames[pname]+"'>"+pnames[pname]+"</option>");
            }
        },
        error: function () {
            alert("error");
            }
         });
        };

    //初始化
    $(function(){
            loadOption_chen();
            loadGrape_chen();
            $("#coloum_div").hide();
            $("#cause_area").hide();

            //时间插件:计算波动率的时间范围
            $('#reportrange span').html('2016-01-01' + ' - ' + moment().format('YYYY-MM-DD'));
            $('#hidden_inform5').val('all')
            $('#hidden_inform6').val('all')


            $('#reportrange').daterangepicker(
                    {
                        // startDate: moment().startOf('day'),
                        //endDate: moment(),
                        minDate: '2016-01-01',    //最小时间
                        maxDate : moment(), //最大时间
                        dateLimit : {
                            days : 100
                        }, //起止时间的最大间隔
                        showDropdowns : true,
                        showWeekNumbers : false, //是否显示第几周
                        timePicker : false, //是否显示小时和分钟
                        timePickerIncrement : 60, //时间的增量，单位为分钟
                        timePicker12Hour : false, //是否使用12小时制来显示时间
                        ranges : {
                            // '最近1小时': [moment().subtract('hours',1), moment()],
                            // '今日': [moment().startOf('day'), moment()],
                            // '昨日': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
                            // '最近7日': [moment().subtract('days', 6), moment()],
                            // '最近30日': [moment().subtract('days', 29), moment()],
                            // '上个月': [moment().subtract('month', 2),moment().subtract('month', 1)]
                            '最近一月': [moment().subtract('month', 1),moment()],
                            '最近三月': [moment().subtract('month', 3),moment()],
                            '最近半年': [moment().subtract('month', 6),moment()],
                            '最近一年': [moment().subtract('years', 1),moment()],
                            '最近两年': [moment().subtract('years', 2),moment()],
                            '所有历史时间':['2016-01-01',moment()],
                        },
                        opens : 'right', //日期选择框的弹出位置
                        buttonClasses : [ 'btn btn-default' ],
                        applyClass : 'btn-small btn-primary blue',
                        cancelClass : 'btn-small',
                        format : 'YYYY-MM-DD', //控件中from和to 显示的日期格式
                        separator : ' to ',
                        locale : {
                            applyLabel : '确定',
                            cancelLabel : '取消',
                            fromLabel : '起始时间',
                            toLabel : '结束时间',
                            customRangeLabel : '自定义',
                            daysOfWeek : [ '日', '一', '二', '三', '四', '五', '六' ],
                            monthNames : [ '一月', '二月', '三月', '四月', '五月', '六月',
                                    '七月', '八月', '九月', '十月', '十一月', '十二月' ],
                            firstDay : 1
                        }
                    }, function(start, end, label) {//格式化日期显示框
                        $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
                        if (label=='所有历史时间'){
                            $('#hidden_inform5').val('all');
                            $('#hidden_inform6').val('all');
                        }else{
                            $('#hidden_inform5').val(start.format('YYYY-MM-DD'));
                            $('#hidden_inform6').val(end.format('YYYY-MM-DD'));
                        }


        });

            });



</script>
{% endblock %}
